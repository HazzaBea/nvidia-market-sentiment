<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVIDIA Market Sentiment Backtesting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loading {
            position: relative;
        }
        .loading:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: #4B5563;
        }
        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">NVIDIA Market Sentiment Backtesting</h1>
            <p class="text-gray-600 mb-8">Analyze historical price movements and sentiment correlation</p>
        </header>

        <!-- Date Selection and Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="startDate" 
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                    <input type="date" id="endDate" 
                           class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <button id="runBacktest" 
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Run Backtest
                    </button>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="chart-container">
                <canvas id="backtest-chart"></canvas>
            </div>
        </div>

        <!-- Results Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Backtest Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Price Change</h3>
                    <p id="priceChange" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Avg. Sentiment</h3>
                    <p id="avgSentiment" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Correlation</h3>
                    <p id="correlation" class="text-3xl font-bold text-gray-800">-</p>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-gray-800">Loading data...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg"></div>
    </div>

    <script>
        // Constants
        const FINNHUB_API_KEY = 'd2s0nrpr01qv11lgk070d2s0nrpr01qv11lgk07g';
        const CHART_COLORS = {
            price: 'rgb(59, 130, 246)',
            sentiment: 'rgb(234, 88, 12)'
        };
        
        let chart = null;

        // Initialize date inputs
        function initializeDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(endDate.getFullYear() - 5);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        // Fetch historical stock data
        async function fetchHistoricalData(startDate, endDate) {
            try {
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=NVDA&token=${config.FINNHUB_API_KEY}`);
                const data = await response.json();
                if (data.c) {
                    document.getElementById('stockPrice').textContent = `$${data.c.toFixed(2)}`;
                } else {
                    throw new Error('Unable to fetch stock price');
                }
            } catch (error) {
                showError('Failed to fetch stock price');
            }
        }

        async function fetchNewsAndSentiment() {
            try {
                const response = await fetch(`https://finnhub.io/api/v1/company-news?symbol=NVDA&from=${getDateString()}&to=${getDateString()}&token=${config.FINNHUB_API_KEY}`);
                const news = await response.json();
                
                if (Array.isArray(news) && news.length > 0) {
                    const newsContainer = document.getElementById('newsContainer');
                    newsContainer.innerHTML = ''; // Clear loading message
                    
                    let totalSentiment = 0;
                    const newsToDisplay = news.slice(0, 5); // Display only 5 most recent news
                    
                    newsToDisplay.forEach(article => {
                        // Simple sentiment calculation (this should be replaced with actual sentiment API data)
                        const sentiment = Math.random() * 2 - 1; // Mock sentiment between -1 and 1
                        totalSentiment += sentiment;
                        
                        const articleElement = document.createElement('div');
                        articleElement.className = 'p-4 border rounded hover:bg-gray-50';
                        articleElement.innerHTML = `
                            <h3 class="font-semibold mb-1">${article.headline}</h3>
                            <p class="text-sm text-gray-600">${new Date(article.datetime * 1000).toLocaleDateString()}</p>
                            <div class="mt-2">
                                <span class="px-2 py-1 rounded text-sm ${getSentimentClass(sentiment)}">
                                    ${getSentimentLabel(sentiment)}
                                </span>
                            </div>
                        `;
                        newsContainer.appendChild(articleElement);
                    });

                    updateOverallSentiment(totalSentiment / newsToDisplay.length);
                } else {
                    throw new Error('No news available');
                }
            } catch (error) {
                showError('Failed to fetch news');
            }
        }

        function updateOverallSentiment(sentimentScore) {
            const sentimentElement = document.getElementById('overallSentiment');
            const indicatorElement = document.getElementById('sentimentIndicator');
            
            // Update text
            const label = getSentimentLabel(sentimentScore);
            sentimentElement.textContent = label;
            
            // Update indicator
            const percentage = ((sentimentScore + 1) / 2) * 100; // Convert -1 to 1 range to 0-100
            indicatorElement.style.background = `linear-gradient(to right, #ef4444 0%, #eab308 50%, #22c55e 100%)`;
            indicatorElement.style.position = 'relative';
            indicatorElement.innerHTML = `<div class="absolute w-2 h-full bg-black" style="left: ${percentage}%"></div>`;
        }

        // Utility functions
        function getDateString() {
            const date = new Date();
            return date.toISOString().split('T')[0];
        }

        function getSentimentLabel(score) {
            if (score > 0.3) return 'Bullish';
            if (score < -0.3) return 'Bearish';
            return 'Neutral';
        }

        function getSentimentClass(score) {
            if (score > 0.3) return 'bg-green-100 text-green-800';
            if (score < -0.3) return 'bg-red-100 text-red-800';
            return 'bg-yellow-100 text-yellow-800';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchStockPrice();
            fetchNewsAndSentiment();
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
            
            // Refresh data every 5 minutes
            setInterval(() => {
                fetchStockPrice();
                fetchNewsAndSentiment();
                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
            }, 300000);
        });
    </script>
</body>
</html>
